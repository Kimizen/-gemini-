# LLM代理服务 - Termux安装使用说明

## 问题修复说明

经过详细分析，原安装脚本存在以下问题，现已全部修复：

### 主要问题及修复：

1. **脚本引用错误** ✅ 已修复
   - 修复了 `一键安装命令.sh` 中引用不存在的 `一键安装-Termux版.sh` 的问题
   - 创建了完整的 `一键安装-完整修复版.sh` 脚本

2. **依赖安装问题** ✅ 已修复
   - 修复了 `llm-proxy-daemon` 中使用错误的依赖文件问题
   - 现在优先使用 `requirements-termux.txt`（针对Termux优化）

3. **网络和权限问题** ✅ 已修复
   - 添加了网络连接检测和超时处理
   - 添加了存储权限检查
   - 自动配置国内pip镜像源

4. **环境检测问题** ✅ 已修复
   - 增强了Termux环境检测
   - 添加了更健壮的错误处理

## 安装步骤

### 方法一：使用完整修复版脚本（推荐）

```bash
# 1. 进入项目目录
cd /path/to/LLM代理服务_Web版

# 2. 给脚本执行权限
chmod +x 一键安装-完整修复版.sh

# 3. 运行安装脚本
./一键安装-完整修复版.sh
```

### 方法二：使用一键安装命令

```bash
# 1. 确保在Termux环境中
# 2. 运行一键安装命令（会自动下载项目）
chmod +x 一键安装命令.sh
./一键安装命令.sh
```

### 方法三：手动分步安装

```bash
# 1. 更新Termux
pkg update -y && pkg upgrade -y

# 2. 安装必要工具
pkg install git curl wget -y

# 3. 克隆项目
git clone https://github.com/adc666sav466/-gemini-.git
cd -gemini-/LLM代理服务_Web版

# 4. 运行修复版安装脚本
chmod +x 一键安装-完整修复版.sh
./一键安装-完整修复版.sh
```

## 安装后配置

### 1. 配置API密钥

安装完成后，必须编辑 `config.ini` 文件，替换示例API密钥：

```bash
# 编辑配置文件
nano config.ini
```

将以下内容：
```ini
group1 = ["AIzaSyCgh-9h5PhprwiGSrk7oNxD5Bl240gI6Fk", ...]
group2 = ["AIzaSyDxG_Dn27XZ-OSeg_iWbGduohqD9gYrGiI", ...]
```

替换为你的真实API密钥。

### 2. 服务管理命令

```bash
# 启动服务
sv up llm-proxy

# 停止服务
sv down llm-proxy

# 重启服务
sv restart llm-proxy

# 查看服务状态
sv status llm-proxy
```

### 3. 日志管理

```bash
# 查看实时日志
tail -f ~/.llm-proxy/logs/llm-proxy.log

# 查看错误日志
tail -f ~/.llm-proxy/logs/llm-proxy-error.log

# 清理日志
> ~/.llm-proxy/logs/llm-proxy.log
> ~/.llm-proxy/logs/llm-proxy-error.log
```

### 4. 测试服务

```bash
# 获取配置的端口
grep -E "^port\s*=" config.ini | cut -d'=' -f2 | tr -d ' '

# 测试服务响应
curl -s http://localhost:8080/

# 测试API接口
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer 123" \
  -d '{"model":"gemini-2.5-flash","messages":[{"role":"user","content":"你好"}]}'
```

## 常见问题解决

### 1. 权限问题

```bash
# 如果遇到权限问题，运行：
termux-setup-storage
```

### 2. 网络问题

```bash
# 如果网络连接有问题，脚本会自动配置国内镜像
# 手动配置pip镜像：
mkdir -p ~/.pip
cat > ~/.pip/pip.conf << EOF
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
trusted-host = pypi.tuna.tsinghua.edu.cn
timeout = 60
EOF
```

### 3. Python版本问题

```bash
# 如果Python命令不存在，安装Python：
pkg install python

# 检查Python版本
python3 --version
```

### 4. 服务启动失败

```bash
# 检查服务状态
sv status llm-proxy

# 查看详细日志
tail -f ~/.llm-proxy/logs/llm-proxy.log
tail -f ~/.llm-proxy/logs/llm-proxy-error.log

# 手动启动测试
python app.py cli
```

### 5. 端口冲突

```bash
# 检查端口占用
netstat -tuln | grep :8080

# 如果端口被占用，可以修改config.ini中的端口配置
nano config.ini
```

## 文件结构说明

```
LLM代理服务_Web版/
├── app.py                          # 主程序文件
├── config.ini                      # 配置文件
├── requirements.txt                # 标准依赖文件
├── 一键安装-完整修复版.sh          # 推荐使用的安装脚本
├── 一键安装命令.sh                 # 自动下载并安装的脚本
├── termux-services/               # Termux服务配置目录
│   ├── llm-proxy-daemon           # 服务启动脚本
│   ├── llm-proxy-daemon-fixed     # 优化版服务启动脚本
│   ├── llm-proxy.service          # systemd服务配置
│   ├── requirements-termux.txt    # Termux优化依赖
│   ├── setup-termux-service.sh    # 基础服务安装脚本
│   ├── setup-termux-service-fixed.sh # 优化版服务安装脚本
│   └── log-manager.sh             # 日志管理脚本
├── static/                        # 静态文件目录
├── templates/                     # 模板文件目录
└── 安装使用说明.md                # 本说明文件
```

## 技术支持

如果安装过程中遇到问题，请：

1. 仔细阅读错误信息
2. 查看日志文件：`~/.llm-proxy/logs/llm-proxy.log`
3. 检查网络连接和权限设置
4. 确保API密钥配置正确

## 更新日志

### v1.0 完整修复版
- 修复了所有已知的安装问题
- 添加了网络检测和超时处理
- 优化了依赖安装流程
- 增强了错误处理和用户提示
- 自动配置国内pip镜像源
- 修复了脚本引用错误

---

**注意**：请确保在Termux环境中运行这些脚本，并已授予必要的存储权限。